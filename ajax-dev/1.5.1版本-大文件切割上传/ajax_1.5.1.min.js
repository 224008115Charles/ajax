(function(window){var initParam={time:0,type:"",url:"",data:"",async:true,dataType:'',isFormData:'',success:function(data){},error:function(x,xx,xxx){},timeout:function(){},requestHeader:{}};var tool={hasOwn:function(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)},is:(function checkType(){var is={types:["Array","Boolean","Date","Number","Object","RegExp","String","Window","HTMLDocument"]};for(var i=0,c;c=is.types[i++];){is[c]=(function(type){return function(obj){var temp=Object.prototype.toString.call(obj)=="[object "+type+"]";if(temp)temp=obj;return temp}})(c)};return is})(),keys:function(obj){if(Object.keys)return Object.keys(obj);var keys=[];for(var key in obj){if(this.hasOwn(obj,key))keys.push(key)};return keys},each:function(obj,callback){var keys=this.keys(obj);if(this.is.Array(obj)&&[].forEach){obj.forEach(callback)}else{var i=0,len=keys.length,key,item;while(i<len){key=keys[i++];item=obj[key];callback.call(obj,item,key)}}},MergeObject:function(target,source){if(Object.assign){return Object.assign(target,source)}var targetKeys=this.keys(target),sourceKeys=this.keys(source),i=0 var len=sourceKeys.length;while(i<len){var key=sourceKeys[i++]target[key]=source[key]}return target},createXhrObject:function(){var xhr;try{XMLHttpRequest?(xhr=new XMLHttpRequest()):(xhr=new ActiveXObject('Microsoft.XMLHTTP'))}catch(e){throw new Error('ajax:Could not create an XHR object.')};return xhr},dealWithParam:function(ajaxSetting,that,xhr){switch(ajaxSetting.type.toUpperCase()){case"GET":var getParam="?";tool.each(ajaxSetting.data,function(item,index){getParam+=(encodeURI(index)+"="+encodeURI(item)+"&")});getParam=getParam.substr(0,getParam.length-1);xhr.open(ajaxSetting.type.toUpperCase(),ajaxSetting.url+=getParam,ajaxSetting.async);break;case"POST":xhr.open(ajaxSetting.type.toUpperCase(),ajaxSetting.url,ajaxSetting.async);that.postParam=undefined;if(!(window.FormData&&ajaxSetting.isFormData)){xhr.setRequestHeader("content-type","application/x-www-form-urlencoded");var postParam="";tool.each(ajaxSetting.data,function(item,index){postParam+=(index+"="+item+"&")});postParam=postParam.substr(0,postParam.length-1);that.postParam=postParam}break};return xhr},getIEVersion:function(){return function(){if(window.VBArray){var mode=document.documentModereturn mode?mode:window.XMLHttpRequest?7:6}else{return NaN}}()},cutFile:function(file,cutSize){var count=file.size/cutSize|0,fileArr=[];for(var i=0;i<count;i++){fileArr.push({name:file.name+".part"+(i+1),file:file.slice(cutSize*i,cutSize*(i+1))})};fileArr.push({name:file.name+".part"+(count+1),file:file.slice(cutSize*count,file.size)});return fileArr}};var tempObj={common:function(options){var ajaxSetting=tool.MergeObject(initParam,options),sendData=null;var xhr=tool.createXhrObject();xhr.overrideMimeType?(xhr.overrideMimeType("text/javascript")):(null);xhr.onload===undefined?(xhr.xhr_ie8=true):(xhr.xhr_ie8=false);ajaxSetting.data===""?(xhr.open(ajaxSetting.type.toUpperCase(),ajaxSetting.url,ajaxSetting.async)):(xhr=tool.dealWithParam(ajaxSetting,this,xhr));ajaxSetting.async?(xhr.timeout=ajaxSetting.time):(null);tool.each(ajaxSetting.requestHeader,function(item,index){xhr.setRequestHeader(index,item)});xhr.onload=function(e){if(this.status==200||this.status==304){ajaxSetting.dataType.toUpperCase()=="JSON"?(ajaxSetting.success(JSON.parse(xhr.responseText))):(ajaxSetting.success(xhr.responseText))}else{ajaxSetting.error(e.currentTarget.status,e.currentTarget.statusText)}};xhr.onreadystatechange=function(){switch(xhr.readyState){case 1:break;case 2:break;case 3:break;case 4:xhr.xhr_ie8?((xhr.status==200||xhr.status==304)?(ajaxSetting.dataType.toUpperCase()=="JSON"?(ajaxSetting.success(JSON.parse(xhr.responseText))):(ajaxSetting.success(xhr.responseText))):(null)):(null);break}};xhr.ontimeout=function(e){ajaxSetting.timeout(999,e?(e.type):("timeout"));xhr.abort();};xhr.onerror=function(e){ajaxSetting.error()};if(this.postParam){!!(this.postParam)?(sendData=this.postParam):(sendData=null)}else{sendData=ajaxSetting.data}xhr.send(sendData)},get:function(url,data,success,error,timeout){var ajaxParam={type:"get",url:url,data:data,success:success,error:error,timeout:timeout};ajax.common(ajaxParam)},post:function(url,data,success,error,timeout){var ajaxParam={type:"post",url:url,data:data,success:success,error:error,timeout:timeout};ajax.common(ajaxParam)},postFormData:function(url,formData,success,error,timeout){var ajaxParam={type:"post",url:url,data:formData,isFormData:true,success:success,error:error,timeout:timeout};ajax.common(ajaxParam)},postSync:function(url,data,success,error,timeout){var ajaxParam={type:"post",url:url,data:data,async:false,success:success,error:error,timeout:timeout};ajax.common(ajaxParam)},longPolling:function(url,data,successEvent,isAll,timeout,timeFrequency,errorEvent,timeoutEvent){var ajaxParam={time:timeout,type:"post",url:url,data:data,async:false,success:function(date){successEvent(data);var timer=setTimeout(function(){tempObj.longPolling(url,data,successEvent,isAll,errorEvent,timeoutEvent)},timeFrequency);if(!isAll)clearTimeout(timer)},error:errorEvent,timeout:function(){timeoutEvent();setTimeout(function(){tempObj.longPolling(url,data,successEvent,isAll,errorEvent,timeoutEvent)},timeFrequency)}};ajax.common(ajaxParam)},upload:function(url,fileSelector,size,fileType,success,error,timeout){var formdata=new FormData(),fileNode=document.querySelector(fileSelector),fileCount=fileNode.files.length,data={},result={};if(fileCount>0){tool.each(Array.prototype.slice.call(fileNode.files),function(value){if(value.size>size){result["status"]=1;result["errMsg"]="超出文件限制大小"}else{if(fileType!="*"){if(fileType.indexOf(value.type)===-1){result["status"]=2;result["errMsg"]="非允许文件格式"}else{formdata.append(value.name,value)}}}})}else{result["status"]=0;result["errMsg"]="请选择文件"};if(result.status!==undefined)return result;var ajaxParam={type:"post",url:url,data:formdata,isFormData:true,success:success,error:error,timeout:timeout};ajax.common(ajaxParam)},upload_big:function(url,fileSelector,cutSize,fileType,successEvent,progressEvent,errorEvent,timeoutEvent){var file=document.querySelector(fileSelector).files,result={};if(file.length===1){if(fileType!="*"){if(fileType.indexOf(file.type)===-1){result["status"]=1;result["errMsg"]="非允许文件格式"}}}else{result["status"]=0;result["errMsg"]="请选择文件/只能上传一个文件"};if(file[0].size>cutSize){var fileArr=tool.cutFile(file[0],cutSize);cutFile_upload(fileArr)}else{return tempObj.upload(url,fileSelector,file[0].size,fileType,successEvent,errorEvent,timeoutEvent)};function cutFile_upload(fileArr,count){var formData=new FormData();if(count==undefined){count=0;formData.append("count",count);formData.append("name",fileArr[0].name);formData.append("file".name,fileArr[0].file)}else{if(count===fileArr.length-1){formData.append("isLast","true")};formData.append("count",count);formData.append("name",fileArr[count].name);formData.append("file".name,fileArr[count].file)};var ajaxParam={type:"post",url:url,data:formData,isFormData:true,success:function(data){progressEvent(count+1,fileArr.length);var currCount=Number(data);if(currCount){if(currCount!=fileArr.length){cutFile_upload(fileArr,currCount)}};successEvent(data);},error:errorEvent,timeout:timeoutEvent};ajax.common(ajaxParam)}},};var outputObj=function(){if(tool.getIEVersion()<7){throw new Error("Sorry,please upgrade your browser.(IE8+)")}return tempObj};window.ajax=new outputObj()})(this);